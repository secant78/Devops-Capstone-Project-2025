trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # --- CONFIGURATION (Update these matches your setup) ---
  azureSubscription: 'azure-connection'   # Name of ARM Service Connection
  k8sConnection: 'aks-connection'         # Name of Kubernetes Service Connection
  dockerRegistryConnection: 'acr-connection' # Name of Docker Registry Service Connection
  
  acrName: 'seanacrproject'                   # Your ACR Name (e.g., seanacrproject)
  acrLoginServer: 'seanacrproject.azurecr.io' # Your Full ACR Login Server
  namespace: 'k8s-assessment'             # Namespace defined in 00-namespace.yaml
  # -------------------------------------------------------

steps:
  # 1. Build & Push Backend A
  - task: Docker@2
    displayName: 'Build & Push Backend A'
    inputs:
      containerRegistry: '$(dockerRegistryConnection)'
      repository: 'backend-a'
      command: 'buildAndPush'
      Dockerfile: 'backend-a/Dockerfile'
      tags: |
        $(Build.BuildId)
        latest

  # 2. Build & Push Backend B
  - task: Docker@2
    displayName: 'Build & Push Backend B'
    inputs:
      containerRegistry: '$(dockerRegistryConnection)'
      repository: 'backend-b'
      command: 'buildAndPush'
      Dockerfile: 'backend-b/Dockerfile'
      tags: |
        $(Build.BuildId)
        latest

  # 3. Create ACR Pull Secret (So AKS can pull images)
  # NOTE: You must set 'acrPassword' as a secret variable in the Pipeline UI
  - task: Kubernetes@1
    displayName: 'Create/Update ACR Secret'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '$(k8sConnection)'
      namespace: '$(namespace)'
      command: 'login' # Sets up kubectl context for the next script script

  - script: |
      kubectl create secret docker-registry acr-secret \
        --docker-server=$(acrLoginServer) \
        --docker-username=$(acrName) \
        --docker-password=$(acrPassword) \
        --docker-email=admin@example.com \
        --dry-run=client -o yaml | kubectl apply -f -
    displayName: 'Apply ACR Secret'
    env:
      acrPassword: $(acrPassword) # Maps the secret variable from UI to env

  # 4. Deploy Manifests to AKS
  - task: KubernetesManifest@0
    displayName: 'Deploy to AKS'
    inputs:
      action: 'deploy'
      kubernetesServiceConnection: '$(k8sConnection)'
      namespace: '$(namespace)'
      # List all the files you kept in your k8s folder
      manifests: |
        k8s/00-namespace.yaml
        k8s/01-configmaps.yaml
        k8s/02-secrets.yaml
        k8s/03-network-policy.yaml
        k8s/04-resource-quota.yaml
        k8s/20-backend-a.yaml
        k8s/21-backend-b.yaml
        k8s/40-hpa.yaml
        k8s/50-ingress.yaml
      # Swaps the 'latest' tag in your yaml with the specific Build ID for this run
      containers: |
        $(acrLoginServer)/backend-a:$(Build.BuildId)
        $(acrLoginServer)/backend-b:$(Build.BuildId)
      imagePullSecrets: 'acr-secret'